
resource "yandex_iam_service_account" "sa_private_registry" {
  name        = "pusher"
  description = "Service account for private registry"
  folder_id   = var.folder_id
}

resource "yandex_iam_service_account" "sa_test_registry" {
  name        = "sa-test-registry"
  description = "Service account for test registry"
  folder_id   = var.folder_id
}

resource "yandex_container_registry_iam_binding" "test_puller" {
  registry_id = yandex_container_registry.test_registry.id
  role        = "container-registry.images.puller"
  members = [
    "serviceAccount:${yandex_iam_service_account.sa_test_registry.id}",
  ]
}

resource "yandex_container_registry_iam_binding" "test_pusher" {
  registry_id = yandex_container_registry.test_registry.id
  role        = "container-registry.images.pusher"
  members = [
    "serviceAccount:${yandex_iam_service_account.sa_test_registry.id}",
  ]
}

resource "yandex_container_registry_iam_binding" "private_puller" {
  registry_id = yandex_container_registry.private_registry.id
  role        = "container-registry.images.puller"
  members = [
    "serviceAccount:${yandex_iam_service_account.sa_private_registry.id}",
  ]
}

resource "yandex_container_registry_iam_binding" "private_pusher" {
  registry_id = yandex_container_registry.private_registry.id
  role        = "container-registry.images.pusher"
  members = [
    "serviceAccount:${yandex_iam_service_account.sa_private_registry.id}",
  ]
}

resource "yandex_container_registry" "test_registry" {
  name      = "test-registry"
  folder_id = var.folder_id
}

resource "yandex_container_registry" "private_registry" {
  name      = "private-registry"
  folder_id = var.folder_id

  provisioner "local-exec" {
    when    = destroy
    command = "./yc_delete_profile.sh"
  }
}

resource "null_resource" "registry_auth" {
  triggers = {
    name : yandex_iam_service_account.sa_private_registry.name
    random : "5"
  }
  provisioner "local-exec" {
    command = "./yc_register_script.sh ${yandex_iam_service_account.sa_private_registry.name} ${var.folder_id} ${yandex_container_registry.private_registry.id} ${yandex_iam_service_account.sa_test_registry.name}"
  }
  depends_on = [
    yandex_container_registry.test_registry,
    yandex_container_registry.private_registry
  ]
}
