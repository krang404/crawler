
# Приложение crawler

Приложение состоит из двух микросервисов. Crawler парсит указанные в конфигурации сайты и сохраняет данные в БД MongoDB, а микросервис UI представляет собой интерефейс для поиска в БД.

# Проект crawler

Данный проект содержит инфраструктурный код для развертывания приложения в облаке Yandex Cloud.

## Инфраструктура в контейнерах

Для тестирования сборки проекта и его функционирования инфраструктура может быть развернута в контейнерах на одной ВМ с помощью Terrafrom и Ansible. Контейнерое развертывание используется в качестве средства демонстрации или тестирования продукта разработки. Это не prodaction-решение.

Необходимые предустановки для запуска проекта:

- Terraform v1.0 и выше
- Ansible v2.11 и выше
- Yandex CLI v0.90 и выше
- Подключенный сервисный аккаунт для работы в Yandex Cloud

### Screencast развертывания проекта

Screencast развертывания инфраструктуры в контейнерах доступен по ссылке

[Яндекс.Диск](https://disk.yandex.ru/i/wGKWKUBjvQjarg "Скринкаст развертывания")

### Terraform

Минимально необходимое количество ресурсов для демонстрационного проекта:

- Вируальная машина (CPU - 2 Core, RAM - 8 Gb)
- Yandex Cloud Container Registry

Инфраструктурный код находится в папке /infra/terraform и описывает провиженнинг ВМ и создание Container Registry в облаке Yandex.Cloud. Для запуска достаточно подставить переменные в variables.tf и запустить terraform apply.

После успешного провиженнинга в outputs будут выведены внешний IP виртуальной машины и ID Container Registry. Эти данные понадобятся для дальнейшего развертывания инфраструктуры и запуска pipeline CI/CD.

Внешний IP и ID Container Registry передаются в inventory и файл переменных для Ansible (/infra/ansible/variables.yml),что добавляет больше автоматизации в развертывание.
Формирование файла с переменными производится через провайдера local, как ресурс конфигурации, поэтому при удалении инфраструктуры файл с переменными также удаляется.

Также для работы Credental Helper потребуется привязать сервисный аккаунт, который описывается в модуле test_registry к ВМ. К сожалению ресурсы, предоставляемые провайдером Yandex для Terraform, не позволяют реализовать это через код конфигурации. Поэтому по окончании провиженнинга ВМ будет запущен скрипт infra/terraform/yc_register_script.sh, который внесет id сервисного аккаунта в метаданные ВМ. Также данный скрипт запросит credential для этого же сервисного аккаунта и выгрузит эти данные в файл infra/ansible/templates/key.json. Ключи потребуются для логина в приватное хранилище при развертывании тестовой инсталляции приложения crawler.


### Ansible

Инфраструктура разветывается в контейнерах с использованием Docker Compose. Все необходмые переменные уже определны в ходе работы Terraform. Единственное исключение описано ниже.

Во-первых, необходимо установить все пакеты docker и зависимости к ним на удаленный хост. Вся установка описана в плейбуке /infra/ansible/install_docker.yml

    ansible-playbook install_docker.yml

После установки Docker можно запускать развертывание контейнеров с Gitlab и Gitlab-Runner.
    ansible-playbook gitlab_up.yml

Регистрация раннера производится с помощью плейбука /infra/ansible/registr_runner.yml, запуск которого нужно осуществлять, определяя переменную YOUR_TOKEN. Получить токен в данной инсталляции можно только вручную (см. Gitlab и CI/CD)

    ansible-playbook registr_runner.yml -e YOUR_TOKEN=your_token

### Ручные операции

После запуска контейнеров с Gitlab необходимо зайти на удаленный хост и взять дефолтный пароль от root в /srv/gitlab/config/initial_root_password. Под этим паролем логинимся в веб-интерефейсе Gitlab, создаем группу и проект и далее получаем токен для регистрации Gitlab-runner.

### Gitlab и CI/CD

После запуска репозитория можно начинать работать над тестированием и развертыванием приложения crawler. Для удобства внесем инфраструктурный код в .gitignore, чтобы не занимать места в тестовом репозитории.

Для начала добавим репозиторий в наш локальный git. Исходники микросервисов и скрипты для тестирования расположены в директории crawler. Здесь же находятся и Dockerfile для сборки образов.

Pipeline для непрерывной поставки описан в .gitlab-ci.yml. Он включает в себя 3 стадии: тестирование исходного кода, тестирование сборки образа и деплой образа в приватное хранилище для последующего развертывания в тестовой среде.

Логин в приватное хранилище осуществляется через Credential Helper, который предоставляет Yandex Cloud. Для этого мы вызовем его через образ cr.yandex/yc/metadata-token-docker-helper:0.2, который считает метаданные ВМ и подставить необходимые credential для логина.

Поскольку мы используем приватное хранилище, ссылка на образ принимает вид cr.yandex/registry_id/name_of_image. registry_id мы получили при провиженнинге виртуальной машины через Terraform. Этот ID хранится в переменной $YA_REGISTRY, которая определена при регистрации Gitlab-Runner.

При успешном завершении, итогом pipeline станут артефакты в виде образов микросервисов в приватном хранилище. Далее эти образы будут использованы при развертывании демонстрационной/тестовой инсталляции.

### Развертывание инсталляции

Запуск контейнеров с приложением осуществляется через плейбук /infra/ansible/crawler_up.yml.

    ansible-playbook crawler_up.yml

### Описание инсталляции

При успешном развертывании мы получаем работающий стенд, на котором, помимо Gitlab, запущены контейнера с микросервисами crwaler и crawler_ui, очередь RabbitMQ, БД MongoDB, сервис мониторинга Prometheus и node-exporter к нему, а также cAdvisor для мониторинга состояния контейнерной нагрузки.

Визуализация интерфейсов:

- crawler_ui http://HOST_IP:8000
- Prometheus http://HOST_IP:9090
- cAdvisor http://HOST_IP:8080
