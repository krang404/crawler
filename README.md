# Приложение crawler

Приложение состоит из двух микросервисов. Crawler парсит указанные в конфигурации сайты и сохраняет данные в БД MongoDB, а микросервис UI представляет собой интерефейс для поиска в БД.

# Проект crawler

Данный проект содержит инфраструктурный код для развертывания приложения в облаке Yandex Cloud.

## Инфраструктура в контейнерах

Для тестирования сборки проекта и его функционирования инфраструктура может быть развернута в контейнерах на одной ВМ с помощью Terrafrom и Ansible. Контейнерое развертывание используется в качестве средства демонстрации или тестирования продукта разработки. Это не prodaction-решение.

### Terraform

Минимально необходимое количество ресурсов для демонстрационного проекта:

- Вируальная машина (CPU - 2 Core, RAM - 8 Gb)
- Yandex Cloud Container Registry

Инфраструктурный код находится в папке /infra/terraform и описывает провиженнинг ВМ и создание Container Registry в облаке Yandex.Cloud. Для запуска достаточно подставить переменные в variables.tf и запустить terraform apply.

После успешного провиженнинга в outputs будут выведены внешний IP виртуальной машины и ID Container Registry. Эти данные понадобятся для дальнейшего развертывания инфраструктуры и запуска pipeline CI/CD.

### Ansible

Инфраструктура разветывается в контейнерах с использованием Docker Compose. Inventory в нашем случае заполняется вручную: достаточно внести IP из outputs.

Далее необходимо установить все пакеты docker и зависимости к ним на удаленный хост. Вся установка описана в плейбуке /infra/ansible/install_docker.yml

После установки Docker можно запускать развертывание контейнеров с Gitlab и Gitlab-Runner. Плейбук /infra/ansible/gitlab_up.yml необходимо запускать, определяя переменную YOUR_VM_IP, значение которой - внешний адрес удаленного хоста.

Регистрация раннера производится с помощью плейбука /infra/ansible/registr_runner.yml, запуск которого нужно осуществлять определяя переменные YOUR_VM_IP и YOUR_TOKEN. Получить токен в данной инсталляции можно только вручную (см. Ручные операции)

### Ручные операции

После запуска контейнеров с Gitlab необходимо зайти на удаленный хост и взять дефолтный пароль от root в /srv/gitlab/config/initial_root_password. Под этим паролем необходимо залогиниться в веб-интерефейсе Gitlab, создать группу и проект и далее получить токен для регистрации Gitlab-runner.

### Gitlab и CI/CD

После запуска репозитория можно начинать работать над тестированием и развертыванием приложения crawler.

Для начала добавим репозиторий в наш локальный git. Исходники микросервисов и скрипты для тестирования расположены в директории crawler. Здесь же находятся и Dockerfile для сборки образов.

Pipeline для непрерывной поставки описан в .gitlab-ci.yml. Он включает в себя 3 стадии: тестирование исходного кода, тестирование сборки образа и деплой образа в приватное хранилище для последующего развертывания в тестовой среде.

Логин в приватное хранилище осуществляется по IAM-токену, получение которого проходит от имени сервисного аккаунта через Yandex CLI.

Поскольку мы используем приватное хранилище, ссылка на образ принимает вид cr.yandex/registry_id/name_of_image. registry_id мы получили при првиженнинге виртуальной машины через Terraform.

При успешном завершении, итогом pipeline станут артефакты в виде образов микросервисов в приватном хранилище.
